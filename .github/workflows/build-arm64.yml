name: Build ARM64 Executable for Kylin OS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU for cross-compilation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build ARM64 executable in Docker
      run: |
        cat > Dockerfile.arm64 << 'EOF'
        FROM python:3.8-slim
        
        WORKDIR /app
        
        # Install system dependencies
        RUN apt-get update && apt-get install -y \
            python3-pyqt5 \
            python3-pyqt5.qtchart \
            libqt5gui5 \
            libqt5widgets5 \
            libqt5core5a \
            build-essential \
            python3-dev
            
        # Copy project files
        COPY . .
        
        # Install Python dependencies
        RUN pip install pyinstaller openpyxl reportlab python-dateutil pandas==2.0.3 Pillow
        
        # Build executable
        RUN pyinstaller --onefile \
            --name youth_records_kylin_arm64 \
            --add-data "database:database" \
            --add-data "services:services" \
            --add-data "ui:ui" \
            --add-data "utils:utils" \
            --add-data "youth_records.db:." \
            main.py
        EOF
        
        # Build ARM64 Docker image and extract executable
        docker buildx build --platform linux/arm64 --load -t youth-arm64 -f Dockerfile.arm64 .
        docker run --platform linux/arm64 --name temp-container youth-arm64 ls /app/dist
        docker cp temp-container:/app/dist/youth_records_kylin_arm64 ./youth_records_kylin_arm64
        docker rm temp-container
          
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp dist/youth_records_kylin_arm64 deployment/
        cp youth_records.db deployment/
        cp -r 示例数据 deployment/
        
        # 创建启动脚本
        cat > deployment/start.sh << 'EOF'
        #!/bin/bash
        # ARM64麒麟系统启动脚本
        export DISPLAY=:0
        export QT_QPA_PLATFORM=xcb
        
        # 检查X11显示
        if [ -z "$DISPLAY" ]; then
            echo "警告: 未设置DISPLAY环境变量"
            export DISPLAY=:0
        fi
        
        # 启动应用程序
        cd "$(dirname "$0")"
        ./youth_records_kylin_arm64
        
        echo "程序已退出"
        read -p "按任意键继续..."
        EOF
        
        chmod +x deployment/start.sh
        chmod +x deployment/youth_records_kylin_arm64
        
        # 创建README
        cat > deployment/README.txt << 'EOF'
        # 一人一策记录本 - ARM64麒麟系统版
        
        ## 系统要求
        - ARM64架构的麒麟操作系统
        - 已安装X11显示服务器
        - 至少512MB可用内存
        
        ## 运行程序
        方法1: 双击 start.sh 脚本
        方法2: 在终端中执行 ./start.sh
        方法3: 直接执行 ./youth_records_kylin_arm64
        
        ## 故障排除
        如果程序无法启动，请检查：
        1. 是否有X11显示服务器运行
        2. DISPLAY环境变量是否正确设置
        3. 是否有足够的系统权限
        
        ## 文件说明
        - youth_records_kylin_arm64: 主程序可执行文件
        - youth_records.db: 数据库文件
        - 示例数据/: 示例数据文件夹
        - start.sh: 启动脚本
        EOF
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: youth-records-kylin-arm64
        path: deployment/
        retention-days: 30
        
    - name: Create Release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          deployment/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
