name: Build Final Kylin ARM64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-final:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create Dockerfile
      run: |
        echo 'FROM --platform=linux/arm64 ubuntu:20.04' > Dockerfile.final
        echo 'ENV DEBIAN_FRONTEND=noninteractive' >> Dockerfile.final
        echo 'ENV PYTHONUNBUFFERED=1' >> Dockerfile.final
        echo 'WORKDIR /app' >> Dockerfile.final
        echo 'RUN apt-get update && apt-get install -y python3.8 python3-pip python3-pyqt5 python3-pyqt5.qtchart libqt5core5a libqt5gui5 libqt5widgets5 libqt5charts5 libx11-6 libxext6 libxrender1 fonts-dejavu-core build-essential && rm -rf /var/lib/apt/lists/*' >> Dockerfile.final
        echo 'COPY . .' >> Dockerfile.final
        echo 'RUN pip3 install PyQt5==5.15.10 PyQt5-sip==12.13.0 PyQtChart==5.15.6 openpyxl==3.1.2 Pillow==10.2.0 reportlab==4.0.9 python-dateutil==2.8.2 pandas==2.0.3 pyinstaller==6.3.0' >> Dockerfile.final
        echo 'RUN pyinstaller --onefile --windowed --name youth_records_kylin --add-data "database:database" --add-data "services:services" --add-data "ui:ui" --add-data "utils:utils" --add-data "youth_records.db:." --hidden-import PyQt5.QtCore --hidden-import PyQt5.QtGui --hidden-import PyQt5.QtWidgets --hidden-import PyQt5.QtChart --hidden-import openpyxl --hidden-import pandas --hidden-import reportlab --hidden-import PIL main.py' >> Dockerfile.final
        
    - name: Build Docker image
      run: |
        docker buildx build --platform linux/arm64 --output type=local,dest=./output -f Dockerfile.final .
        
    - name: Create package
      run: |
        mkdir -p final_package
        cp output/dist/youth_records_kylin final_package/
        chmod +x final_package/youth_records_kylin
        cp youth_records.db final_package/
        echo '#!/bin/bash' > final_package/start.sh
        echo 'export DISPLAY=:0' >> final_package/start.sh
        echo 'export QT_QPA_PLATFORM=xcb' >> final_package/start.sh
        echo 'cd "$(dirname "$0")"' >> final_package/start.sh
        echo './youth_records_kylin' >> final_package/start.sh
        chmod +x final_package/start.sh
        echo '银河麒麟V10使用说明' > final_package/README.txt
        echo '1. chmod +x youth_records_kylin' >> final_package/README.txt
        echo '2. ./start.sh' >> final_package/README.txt
        ls -la final_package/
        file final_package/youth_records_kylin
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: youth-records-kylin-final
        path: final_package/
        retention-days: 30
